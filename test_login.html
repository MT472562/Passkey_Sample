<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .login-section {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 10px;
            min-width: 300px;
            text-align: center;
        }
        .btn {
            display: inline-block;
            margin: 10px;
            padding: 12px 24px;
            background-color: #4f46e5;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 16px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        .btn:hover {
            background-color: #3730a3;
        }
        .btn-passwordless {
            background-color: #059669;
        }
        .btn-passwordless:hover {
            background-color: #047857;
        }
        .divider {
            margin: 20px 0;
            text-align: center;
            color: #6b7280;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <!-- Discoverable Credentials ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div class="login-section">
        <h2>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ä¸è¦ï¼</p>
        <button id="passwordlessBtn" class="btn btn-passwordless">ãƒ‘ã‚¹ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>


    <a href="/" class="btn" style="background-color: #6b7280; width: auto;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</a>

    <script>
        function base64urlToUint8Array(base64urlString) {
            let base64 = base64urlString.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4 !== 0) base64 += '=';
            const str = atob(base64);
            const bytes = new Uint8Array(str.length);
            for (let i = 0; i < str.length; ++i) bytes[i] = str.charCodeAt(i);
            return bytes;
        }
        function uint8ArrayToBase64url(bytes) {
            let str = '';
            for (let i = 0; i < bytes.length; ++i) str += String.fromCharCode(bytes[i]);
            let base64 = btoa(str);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆDiscoverable Credentialsï¼‰
        document.getElementById('passwordlessBtn').addEventListener('click', async function(event) {
            event.preventDefault();
            
            try {
                // Discoverable Credentialsç”¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¾—
                const optionsResponse = await fetch('/api/login/discoverable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const options = await optionsResponse.json();

                if (!options.challenge) {
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    return;
                }

                // challengeã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                options.challenge = base64urlToUint8Array(options.challenge);

                console.log('ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ã€‘WebAuthné–‹å§‹');

                // WebAuthnèªè¨¼ï¼ˆallowCredentialsã¯ç©ºãªã®ã§èªè¨¼å™¨ãŒè‡ªå‹•é¸æŠï¼‰
                const assertion = await navigator.credentials.get({ publicKey: options });

                // ã‚µãƒ¼ãƒãƒ¼ã¸èªè¨¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡
                const assertionForServer = {
                    id: assertion.id,
                    type: assertion.type,
                    rawId: uint8ArrayToBase64url(new Uint8Array(assertion.rawId)),
                    response: {
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(assertion.response.clientDataJSON)),
                        authenticatorData: uint8ArrayToBase64url(new Uint8Array(assertion.response.authenticatorData)),
                        signature: uint8ArrayToBase64url(new Uint8Array(assertion.response.signature)),
                        userHandle: assertion.response.userHandle
                            ? uint8ArrayToBase64url(new Uint8Array(assertion.response.userHandle))
                            : null,
                    },
                };

                const verifyResponse = await fetch('/api/login/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential: assertionForServer })
                });
                const verifyResult = await verifyResponse.json();
                
                if (verifyResult.success) {
                    alert(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${verifyResult.username || 'ä¸æ˜'}`);
                } else {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (verifyResult.error || 'åŸå› ä¸æ˜'));
                }
            } catch (err) {
                console.error(err);
                if (err.name === 'NotAllowedError') {
                    alert('èªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
                }
            }
        });

        // å¾“æ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åæŒ‡å®šãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('loginBtn').addEventListener('click', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            if (!username) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                // ã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¨credentialIdã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const optionsResponse = await fetch('/api/login/options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const options = await optionsResponse.json();

                if (!options.challenge) {
                    alert('ç™»éŒ²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                // challengeã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                options.challenge = base64urlToUint8Array(options.challenge);
                
                // allowCredentialsãŒç©ºã§ãªã„å ´åˆã®ã¿ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ã¨ã®äº’æ›æ€§ï¼‰
                if (options.allowCredentials && options.allowCredentials.length > 0) {
                    options.allowCredentials = options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64urlToUint8Array(cred.id)
                    }));
                }

                // WebAuthnèªè¨¼
                const assertion = await navigator.credentials.get({ publicKey: options });

                // ã‚µãƒ¼ãƒãƒ¼ã¸èªè¨¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡
                const assertionForServer = {
                    id: assertion.id,
                    type: assertion.type,
                    rawId: uint8ArrayToBase64url(new Uint8Array(assertion.rawId)),
                    response: {
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(assertion.response.clientDataJSON)),
                        authenticatorData: uint8ArrayToBase64url(new Uint8Array(assertion.response.authenticatorData)),
                        signature: uint8ArrayToBase64url(new Uint8Array(assertion.response.signature)),
                        userHandle: assertion.response.userHandle
                            ? uint8ArrayToBase64url(new Uint8Array(assertion.response.userHandle))
                            : null,
                    },
                };

                const verifyResponse = await fetch('/api/login/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential: assertionForServer, username })
                });
                const verifyResult = await verifyResponse.json();
                if (verifyResult.success) {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼');
                } else {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (verifyResult.error || 'åŸå› ä¸æ˜'));
                }
            } catch (err) {
                console.error(err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });
    </script>
</body>
</html>
