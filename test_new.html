<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>パスキー登録</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
    </style>
</head>
<body>
    <form>
        <input type="text" id="username" name="username" placeholder="ユーザー名" required>
        <button type="submit" id="submit">保存</button>
    </form>
    <script>
        function base64urlToUint8Array(base64urlString) {
            let base64 = base64urlString.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4 !== 0) base64 += '=';
            const str = atob(base64);
            const bytes = new Uint8Array(str.length);
            for (let i = 0; i < str.length; ++i) bytes[i] = str.charCodeAt(i);
            return bytes;
        }
        function uint8ArrayToBase64url(bytes) {
            let str = '';
            for (let i = 0; i < bytes.length; ++i) str += String.fromCharCode(bytes[i]);
            let base64 = btoa(str);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        document.getElementById('submit').addEventListener('click', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            if (!username) {
                alert('ユーザー名を入力してください。');
                return;
            }

            try {
                // サーバからオプション取得
                const optionsResponse = await fetch('/api/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const options = await optionsResponse.json();

                // サーバから受け取ったchallengeの値をそのまま出す
                console.log('【JSフロント】受信challenge:', options.challenge);

                options.challenge = base64urlToUint8Array(options.challenge);
                options.user.id = base64urlToUint8Array(options.user.id);

                const credential = await navigator.credentials.create({ publicKey: options });

                // clientDataJSONのchallenge値をデコードして表示
                const clientDataJSON = new Uint8Array(credential.response.clientDataJSON);
                const clientDataStr = new TextDecoder('utf-8').decode(clientDataJSON);
                const clientDataObj = JSON.parse(clientDataStr);
                console.log('【JSフロント】clientDataJSON.challenge:', clientDataObj.challenge);

                // サーバ送信用にBase64URLエンコード
                const credentialForServer = {
                    id: credential.id,
                    type: credential.type,
                    rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                    response: {
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                        attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                    },
                };

                const verificationResponse = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential: credentialForServer, username })
                });
                const verificationResult = await verificationResponse.json();
                if (verificationResult.success) {
                    alert('登録成功！');
                } else {
                    alert('登録失敗: ' + (verificationResult.error || '原因不明'));
                }
            } catch (err) {
                console.error(err);
                alert('エラーが発生しました。コンソールを確認してください。');
            }
        });
    </script>
</body>
</html>